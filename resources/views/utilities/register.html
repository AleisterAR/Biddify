{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/global.css' %}?{% now 'U' %}">
    <script defer src="{% static 'js/app.js' %}?{% now 'U' %}"></script>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css"  rel="stylesheet" />
    <title>Biddify</title>
</head>
<body>
    <section class="bg-gray-50">
        <div class="lg:py-10 sm:py-0">
            <div class="flex flex-col items-center justify-center px-6 py-6 mx-auto lg:py-0">
                <div class="w-full md:mt-4 sm:max-w-lg xl:p-0">
                    <div class="grid grid-cols-3 gap-7">
                        <a class="mt-2 text-blue-800" href="{% url 'home' %}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 25 25" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 ml-2 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                            </svg>
                        </a>
                        <div class="flex mb-5 text-2xl font-semibold text-gray-900">
                            <img class="w-8 h-8 mr-2" src="https://flowbite.s3.amazonaws.com/blocks/marketing-ui/logo.svg" alt="logo">
                            Biddify
                        </div>
                    </div>
                </div>
                <div class="w-full bg-white rounded-lg shadow md:mt-4 sm:max-w-lg xl:p-0 ">
                    <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
                        <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl">
                            Create an account
                        </h1>
                        <form x-data="user_register" class="space-y-4 md:space-y-6" id="registerForm" x-clover-form="submit" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label for="inputFirstname" class="block mb-2 text-sm font-medium text-gray-900 ">Your first name</label>
                                    <input x-clover-verify type="text" name="firstname" id="inputFirstname" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 ">
                                    <div x-text="errors.firstname" class="text-red-500 text-sm mt-1"></div>
                                </div>
                                <div>
                                    <label for="inputLastname" class="block mb-2 text-sm font-medium text-gray-900 ">Your last name</label>
                                    <input x-clover-verify type="text" name="lastname" id="inputLastname" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 ">
                                    <div x-text="errors.lastname" class="text-red-500 text-sm mt-1"></div>
                                </div>
                            </div>
                            <div>
                                <label for="inputEmail" class="block mb-2 text-sm font-medium text-gray-900 ">Your email</label>
                                <input x-clover-verify type="text" name="email" id="inputEmail" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 ">
                                <div x-text="errors.email" class="text-red-500 text-sm mt-1"></div>
                            </div>
                            <div x-data="{
                                username: '',
                                status: '',
                                checkUsername() {
                                    if (this.username.length > 0) {
                                        fetch(`/check_username?username=${this.username}`)
                                            .then(response => response.json())
                                            .then(data => {
                                                if (data.status === 'available') {
                                                    this.status = 'Username is available';
                                                    delete errors['username_duplication']
                                                } else {
                                                    this.status = 'Username is already taken';
                                                    errors['username_duplication'] = true
                                                }
                                            })
                                            .catch(error => {
                                                console.error('Error:', error);
                                                this.status = 'Error checking username';
                                            });
                                    } else {
                                        this.status = '';
                                        delete errors['username_duplication']
                                    }
                                }
                            }">
                                <label for="inputUsername" class="block mb-2 text-sm font-medium text-gray-900 ">Your username</label>
                                <input x-clover-verify type="text" name="username" id="inputUsername" x-model="username" @input.debounce.500ms="checkUsername()" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 ">
                                <div x-text="errors.username" id="username-error" class="text-red-500 text-sm mt-1"></div>
                                <div x-text="status" class="text-sm mt-1" :class="status === 'Username is available' ? 'text-green-500' : 'text-red-500'"></div>
                            </div>
                            <div>
                                <label for="inputPassword" class="block mb-2 text-sm font-medium text-gray-900">Password</label>
                                <input x-clover-verify type="password" name="password" id="inputPassword" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5" >
                                <div x-text="errors.password" class="text-red-500 text-sm mt-1"></div>
                            </div>
                            <div>
                                <label for="inputPasswordConfirm" class="block mb-2 text-sm font-medium text-gray-900">Confirm your password</label>
                                <input x-clover-verify type="password" name="passwordconfirm" id="inputPasswordConfirm" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5" >
                                <div x-text="errors.passwordconfirm" class="text-red-500 text-sm mt-1"></div>
                            </div>
                            <div>
                                <label for="inputPhone" class="block mb-2 text-sm font-medium text-gray-900 ">Your phone number</label>
                                <input type="text" name="phone" id="inputPhone" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 ">                       
                            </div>
                            <div>
                                <label for="inputAddress" class="block mb-2 text-sm font-medium text-gray-900 ">Your address</label>
                                <textarea name="address" id="inputAddress" class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 "></textarea>
                            </div>
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                  <input id="terms" aria-describedby="terms" name="terms" x-clover-verify="terms" type="checkbox" class="w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-0">
                                </div>
                                <div class="ml-3 text-sm">
                                  <label for="terms" class="font-light text-gray-500">I accept the <a class="font-medium hover:text-blue-600 hover:underline" href="#" >Terms and Conditions</a></label>
                                </div>      
                            </div>
                            <div x-text="errors.terms" class="text-red-500 text-sm mt-1"></div>
                            <button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Create an account</button>
                            <p class="text-sm font-light text-gray-500">
                                Already have an account? <a href="{% url 'login' %}" class="font-medium text-primary-600 hover:text-blue-500">Login here</a>
                            </p>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
    <script>
        document.addEventListener("alpine:init", ()=>{
            Alpine.data("user_register", ()=>({
                rule:{
                    firstname:[Clover.rule.required("First name is required!"), Clover.rule.flname("First name must be between 1 and 50 characters long and can only contain letters, spaces, and hyphens.")],
                    lastname:[Clover.rule.required("Last name is required!"), Clover.rule.flname("Last name must be between 1 and 50 characters long and can only contain letters, spaces, and hyphens.")],
                    username: [Clover.rule.required("Username is required!"), Clover.rule.usernameLength("Username must have length of between 3 to 15 characters!"), Clover.rule.usernameRestriction("Username must not contain special characters except \"._-\"")],
                    password: [Clover.rule.required("Password is required!"), Clover.rule.password("Password must be at least 8 characters long, must contain at least one uppercase letter, one lowercase letter, one number and one special character (e.g., !@#$%^&*#).")],
                    passwordconfirm: [Clover.rule.required("Password confirmation is required!"), Clover.rule.passwordconfirm("Two passwords must match!")],
                    email: [Clover.rule.required("Email is required!"), Clover.rule.mail('Please enter a valid email address (e.g., name@example.com).')],
                    terms: [Clover.rule.termsCheck("You must agreee to the Terms and Conditions to continue.")],
                },
                errors: {},
                async submit() {
                const form = this.$el;
                const formData = new FormData(form);
                if (!Object.keys(this.errors).length) {
                    try {
                        const res = await fetch("", {
                            method: "POST",
                            body: formData,
                        });

                        if (!res.ok) {
                            throw res;
                        }
                        const response = await res.json();
                        if (response.status === 'success') {
                            window.location = "/login"
                        } 
                    } catch (error) {
                        
                    }
                } 
            },
            }))
        })
    </script>
</body>
</html>